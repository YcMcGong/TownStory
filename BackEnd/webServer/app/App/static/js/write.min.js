var globalBlob,itemCount=0,itemType=[],imageCount=0,imageFiles=[],uploadURLs=[],accessURLs=[],story_id="",article=[];function getCookie(e){for(var n=e+"=",t=decodeURIComponent(document.cookie).split(";"),o=0;o<t.length;o++){for(var r=t[o];" "==r.charAt(0);)r=r.substring(1);if(0==r.indexOf(n))return r.substring(n.length,r.length)}return""};function renderParagraph(e){return'<div class="row" id=item'+e+'><div class="col-lg-12"><div class="form-group"><label for="paragraph">Paragraph</label><textarea class="form-control" rows="3" id='+e+"></textarea></div></div></div>"}function renderHeader(e){return'<div class="row" id=item'+e+'><div class="col-lg-12"><div class="form-group"><label for="header">Header</label><input type="text" style="font-weight: bold;" class="form-control" id='+e+"></div></div></div>"}function renderImage(e){return'<div class="row" id=item'+e+'><div class="col-lg-12"><br><img id=image'+e+' width="400" alt=""> <input type="file" id="` + itemNumber +`" class="form-control-file" hidden><br></div></div>'}function insertParagraph(){itemCount+=1,itemType.push("paragraph"),text=renderParagraph(itemCount),document.getElementById("article").insertAdjacentHTML("beforeend",text)}function insertHeader(){itemCount+=1,itemType.push("header"),text=renderHeader(itemCount),document.getElementById("article").insertAdjacentHTML("beforeend",text)}function insertImage(){itemCount+=1,imageCount+=1,itemType.push("image"),text=renderImage(itemCount),document.getElementById("article").insertAdjacentHTML("beforeend",text)}function deleteItem(){document.getElementById("item"+itemCount).remove(),"image"==itemType.pop()&&(imageCount-=1,imageFiles.pop()),itemCount-=1}function selectImage(){var t=document.getElementById("image").files[0];insertImage();var e=new FileReader;e.onloadend=function(e){document.getElementById("image"+itemCount).src=this.result,resizeImageFileAndPush(t),$("#myModal").modal("hide")},e.readAsDataURL(t)}function getUploadURLs(){var e=new XMLHttpRequest,t=uploadImgURLs+'?imageCount='+imageCount;e.onreadystatechange=function(){4==this.readyState&&200==this.status&&(response=JSON.parse(this.responseText),uploadURLs=response.uploadURLs,accessURLs=response.accessURLs,submitData())},e.open("GET",t),e.send()}function sendImage(e,t){var a=new XMLHttpRequest({mozSystem:!0});a.onreadystatechange=function(){4==this.readyState&&200==this.status&&(imageCount-=1)<=0&&finished()},a.open("PUT",t,!1);var i=new FileReader;i.onload=function(e){a.send(e.target.result)},i.readAsArrayBuffer(e)}function submitData(){var e=0;for(i=0;i<itemCount;i++)switch(type=itemType[i],type){case"header":var t=document.getElementById((i+1).toString()).value;article.push(["header",t]);break;case"paragraph":t=document.getElementById((i+1).toString()).value;article.push(["paragraph",t]);break;case"image":sendImage(imageFiles[e],uploadURLs[e]),article.push(["image",accessURLs[e]]),e+=1}0==imageCount&&finished()}function finished(){var e=new FormData,t=document.getElementById("title").value,a=document.getElementById("summary").value,i=document.getElementById("city").value;e.append("title",t),e.append("summary",a);var n=JSON.stringify(article);e.append("article",n),e.append("city",i),e.append("latitude",latitude),e.append("longitude",longitude);var d=new XMLHttpRequest({mozSystem:!0});d.onreadystatechange=function(){4==this.readyState&&200==this.status&&(document.getElementById("finishText").innerHTML="Story success!",document.getElementById("finish").disabled=!1,response=JSON.parse(this.responseText),story_id=response.story_id)},d.open("POST",uploadArticleUrl),d.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));d.send(e)}function redirect(){var e=storyUrl+"?story_id="+story_id;window.location.assign(e)}function resizeImageFileAndPush(e){var d=document.createElement("canvas"),r=document.createElement("img"),t=new FileReader;t.onload=function(e){r.src=e.target.result;var t=1280,a=r.width,i=r.height;i<a?t<a&&(i*=t/a,a=t):720<i&&(a*=720/i,i=720),d.width=a,d.height=i,d.getContext("2d").drawImage(r,0,0,a,i);var n=d.toDataURL("image/jpeg",.7);blob=window.dataURLtoBlob&&window.dataURLtoBlob(n),newFile=new File([blob],"imageFile"),imageFiles.push(newFile)},t.readAsDataURL(e)}function validateDataAndSend(){if(document.getElementById("title").value.replace(/\s/g,"").length<5)return document.getElementById("titleWarning").hidden=!1;if(itemCount<=0)return document.getElementById("itemWarning").hidden=!1;var e=document.getElementById("city").value;if(!e)return document.getElementById("cityWaring").hidden=!1;cityfqcn=e,cityfqcn&&jQuery.getJSON(geobyteUrl+"GetCityDetails?callback=?&fqcn="+cityfqcn+geobyteKey,function(e){0<e.geobytescityid?(latitude=e.geobyteslatitude,longitude=e.geobyteslongitude,$("#submitModal").modal("show"),getUploadURLs()):document.getElementById("cityWaring").hidden=!1})}