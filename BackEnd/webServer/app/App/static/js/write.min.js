var globalBlob,itemCount=0,itemType=[],imageCount=0,imageFiles=[],uploadURLs=[],accessURLs=[],story_id="",article=[];function getCookie(e){for(var t=e+"=",n=decodeURIComponent(document.cookie).split(";"),i=0;i<n.length;i++){for(var a=n[i];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(t))return a.substring(t.length,a.length)}return""}function renderParagraph(e){return'<div class="row" id=\'item'+e+'\'>\n        <div class="col-lg-12">\n        <div class="form-group">\n        <label for="paragraph">Paragraph</label>\n        <textarea class="form-control" rows="3" id='+e+"></textarea>\n        </div>\n        </div>\n    </div>"}function renderHeader(e){return'<div class="row" id=\'item'+e+'\'>\n        <div class="col-lg-12">\n        <div class="form-group">\n        <label for="header">Header</label>\n        <input type="text" style="font-weight: bold;" class="form-control" id=\''+e+"'>\n        </div>\n        </div>\n    </div>"}function renderImage(e){return'<div class="row" id=\'item'+e+"'>\n    <div class=\"col-lg-12\">\n    <br>\n        <img id='image"+e+'\' width="400" alt=""> \n        <input type="file" id="'+e+'" class="form-control-file" hidden><br>\n        </div>\n    </div>'}function insertParagraph(){itemCount+=1,itemType.push("paragraph"),text=renderParagraph(itemCount),document.getElementById("article").insertAdjacentHTML("beforeend",text)}function insertHeader(){itemCount+=1,itemType.push("header"),text=renderHeader(itemCount),document.getElementById("article").insertAdjacentHTML("beforeend",text)}function insertImage(){itemCount+=1,imageCount+=1,itemType.push("image"),text=renderImage(itemCount),document.getElementById("article").insertAdjacentHTML("beforeend",text)}function deleteItem(){document.getElementById("item"+itemCount).remove(),"image"==itemType.pop()&&(imageCount-=1,imageFiles.pop()),itemCount-=1}function selectImage(){var e=document.getElementById("image").files[0];insertImage();var t=new FileReader;t.onloadend=function(t){document.getElementById("image"+itemCount).src=this.result,resizeImageFileAndPush(e),$("#myModal").modal("hide")},t.readAsDataURL(e)}function getUploadURLs(){var e=new XMLHttpRequest,t=uploadImgURLs+"?imageCount="+imageCount;e.onreadystatechange=function(){4==this.readyState&&200==this.status&&(response=JSON.parse(this.responseText),uploadURLs=response.uploadURLs,accessURLs=response.accessURLs,submitData())},e.open("GET",t),e.send()}function sendImage(e,t){var n=new XMLHttpRequest({mozSystem:!0});n.onreadystatechange=function(){4==this.readyState&&200==this.status&&(imageCount-=1)<=0&&finished()},n.open("PUT",t);var i=new FileReader;i.onload=function(e){n.send(e.target.result)},i.readAsArrayBuffer(e)}function submitData(){var e=0;for(i=0;i<itemCount;i++)switch(type=itemType[i],type){case"header":""==(t=document.getElementById((i+1).toString()).value)&&(t=" "),article.push(["header",t]);break;case"paragraph":var t;""==(t=document.getElementById((i+1).toString()).value)&&(t=" "),article.push(["paragraph",t]);break;case"image":sendImage(imageFiles[e],uploadURLs[e]),article.push(["image",accessURLs[e]]),e+=1}0==imageCount&&finished()}function finished(){var e=new FormData,t=uploadArticleUrl,n=document.getElementById("title").value,i=document.getElementById("summary").value,a=document.getElementById("city").value;e.append("title",n),e.append("summary",i);var r=JSON.stringify(article);e.append("article",r),e.append("city",a),e.append("latitude",latitude),e.append("longitude",longitude);var o=new XMLHttpRequest({mozSystem:!0});o.onreadystatechange=function(){4==this.readyState&&200==this.status&&(document.getElementById("finishText").innerHTML="Story success!",document.getElementById("finish").disabled=!1,response=JSON.parse(this.responseText),story_id=response.story_id)},o.open("POST",t),o.setRequestHeader("X-CSRFToken",getCookie("csrftoken")),o.send(e)}function redirect(){var e=storyUrl+"?story_id="+story_id;window.location.assign(e)}function resizeImageFileAndPush(e){var t=document.createElement("canvas"),n=document.createElement("img"),i=new FileReader;i.onload=function(e){n.src=e.target.result;var i=n.width,a=n.height;i>a?i>1280&&(a*=1280/i,i=1280):a>720&&(i*=720/a,a=720),t.width=i,t.height=a,t.getContext("2d").drawImage(n,0,0,i,a);var r=t.toDataURL("image/jpeg",.7);blob=window.dataURLtoBlob&&window.dataURLtoBlob(r),newFile=new File([blob],"imageFile"),imageFiles.push(newFile)},i.readAsDataURL(e)}function validateDataAndSend(){if(document.getElementById("title").value.replace(/\s/g,"").length<5)return document.getElementById("titleWarning").hidden=!1,!1;if(itemCount<=0)return document.getElementById("itemWarning").hidden=!1,!1;var e=document.getElementById("city").value;if(!e)return document.getElementById("cityWaring").hidden=!1,!1;cityfqcn=e,cityfqcn&&jQuery.getJSON(geobyteUrl+"GetCityDetails?callback=?&fqcn="+cityfqcn+geobyteKey,function(e){e.geobytesfqcn?(latitude=e.geobyteslatitude,longitude=e.geobyteslongitude,document.getElementById("city").value=e.geobytesfqcn,$("#submitModal").modal("show"),getUploadURLs()):document.getElementById("cityWaring").hidden=!1})}